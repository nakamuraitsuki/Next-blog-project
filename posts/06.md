---
title: 'remark-parseを拡張して独自構文を導入した話'
date: '2025-01-29'
description: 'micromarkやmdast-util-from-Markdownの拡張をUnifiedのエコシステムに組み込んで、独自構文をパースできるようにしました'
---

## 概要
---

私は以前，Unifiedに自作のtransformerのPluginを組み込むことで独自の構文（Tweet構文）を実現していました。
:::tweet
Tweet構文とはわたしのこと
:::

ちなみにそれに関する記事はこちら

:::linkCard
https://ashihara.vercel.app/blog/04
:::

で、今回やりたいのは別の方法で構文を導入することです。

別の方法というのは**remark-parse自体を拡張する**こと。

これによって、Textノードに1回変換せずとも、TweetNodeを作成することができるようになります。

忙しい人のために流れをざっくりと述べておきましょう。
- remark-parseの内部でトークン化を担う**micromark**の拡張を定義
- remark-parseの内部でmdast作成を担う**mdast-util-from-markdown**の拡張を定義
- Unifiedのパイプラインに上記二つの情報を入れ込むためのPlugin作成

さっそく取り組んでいきましょう。

## 方針の掘り下げ（語りパート）
---
この節では、私がどのような経路をたどって拡張方針を立てたのかについて何となく語ります。（自分語り乙）

そもそもこの実装をするきっかけはサークルの先輩のアドバイスでした。

「Textノードを無理やり変換するより、remark-parse自体を拡張したらどうか。」

興味を持った私は早速調べにかかります。

最初に見たのは[remark-parseのソースコード](https://github.com/remarkjs/remark/blob/main/packages/remark-parse/lib/index.js)でした。

ざっくり引用するとこんな感じ
```js index.js
export default function remarkParse(options) {
  const self = this

  self.parser = function (document) {
    return fromMarkdown(document, {
      ...self.data('settings'),
      ...options,
      // Note: these options are not in the readme.
      // The goal is for them to be set by plugins on `data` instead of being
      // passed by users.
      extensions: self.data('micromarkExtensions') || [],
      mdastExtensions: self.data('fromMarkdownExtensions') || []
    })
  }
}
```
コメントアウトにあるように、extensionsやmdastExtensionsなどの拡張はoptionsの中に含まれておらず、**remark-parseに直接引数として渡すことはできません。**

ここが、今まで操作してきたtransformerやstringfyなどとは違うところですね。

プラグインの中でデータが追加されることで、パーサーが間接的に拡張されるような流れを望んでいるように読めました。

次に見たのは[micromarkのREADME.md](https://github.com/micromark/micromark?tab=readme-ov-file#creating-a-micromark-extension)です。

めちゃめちゃ丁寧に拡張の仕方が書いてありました。この記事で書いているトークナイザーはこのやり方をまねている部分が多くあります。

また、より具体的な書き方を知るために、**micromark-extension-directive** という拡張のソースコードも参考にしました。

:::tweet
トークナイザーの実装さえうまくいけば何とかなりそう？
:::

次に見たのは[mdast-util-from-markdown](https://github.com/syntax-tree/mdast-util-from-markdown/tree/main?tab=readme-ov-file#extension)です。

こちらは具体的なやり方が書いていない代わりに、型の内容や使い方が丁寧に記載されていました。

既に提供されている[mdast-util-directive](https://github.com/syntax-tree/mdast-util-directive)のソースコードを覗いたりもしました。

以上のような流れで、機能実現の方針を立てました。